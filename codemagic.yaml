workflows:
  # ===================================================================
  # ============ WORKFLOW UNIFICADO: ANDROID + WEB ====================
  # ===================================================================
  build-android-and-web:
    name: 'Build Completo (Release APK + Web App)'
    instance_type: mac_mini_m2
    environment:
      flutter: 3.19.6 # MUDANÇA ESTRATÉGICA PARA UMA VERSÃO ESTÁVEL E PROVAVELMENTE EM CACHE
      groups:
        - Borracharia
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
        - pattern: develop
          include: true
    scripts:
      - name: Clean and Force Dependency Resolution
        script: |
          set -e
          flutter clean
          flutter pub get
      - name: Set up Android credentials
        script: |
          set -e
          echo "Decodificando credenciais Android..."
          echo $GCLOUD_KEY_FILE | base64 --decode > $CM_BUILD_DIR/android/app/google-services.json
          echo $CM_KEYSTORE | base64 --decode > $CM_BUILD_DIR/android/app/keystore.jks
          cat > $CM_BUILD_DIR/android/key.properties <<EOF
          storePassword=$CM_KEYSTORE_PASSWORD
          keyPassword=$CM_KEY_ALIAS_PASSWORD
          keyAlias=$CM_KEY_ALIAS
          storeFile=keystore.jks
          EOF
          echo "✅ Credenciais Android configuradas com sucesso!"
      - name: Build Android Release APK (Signed)
        script: |
          echo "Iniciando build do APK de Release assinado..."
          flutter build apk --release
      - name: Build Flutter Web
        script: |
          echo "Iniciando build do Flutter Web..."
          flutter build web --release
    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk
      - build/web/**

  # ===================================================================
  # =========== WORKFLOW DE DEBUG (PARA TESTES RÁPIDOS) ===============
  # ===================================================================
  debug-build:
    name: 'Build de Debug (Android APK)'
    instance_type: mac_mini_m2
    environment:
      flutter: 3.19.6 # MUDANÇA ESTRATÉGICA
      groups:
        - Borracharia
    scripts:
      - name: Clean and Force Dependency Resolution
        script: |
          set -e
          flutter clean
          flutter pub get
      - name: Set up Google Services
        script: |
          echo "Decodificando google-services.json..."
          echo $GCLOUD_KEY_FILE | base64 --decode > $CM_BUILD_DIR/android/app/google-services.json
          echo "✅ google-services.json configurado."
      - name: Build Android Debug APK
        script: |
          echo "Iniciando build do APK de Debug..."
          flutter build apk --debug
    artifacts:
      - build/app/outputs/flutter-apk/app-debug.apk

  # ===================================================================
  # ============ WORKFLOW DE PROFILE (PARA DIAGNÓSTICO) ==========
  # ===================================================================
  profile-build:
    name: 'Build de Profile (Diagnóstico Android)'
    instance_type: mac_mini_m2
    environment:
      flutter: 3.19.6 # MUDANÇA ESTRATÉGICA
      groups:
        - Borracharia
    scripts:
      - name: Clean and Force Dependency Resolution
        script: |
          set -e
          flutter clean
          flutter pub get
      - name: Set up Google Services
        script: |
          echo "Decodificando google-services.json..."
          echo $GCLOUD_KEY_FILE | base64 --decode > $CM_BUILD_DIR/android/app/google-services.json
          echo "✅ google-services.json configurado."
      - name: Build Android Profile APK
        script: |
          echo "Iniciando build do APK de Profile para diagnóstico..."
          flutter build apk --profile
    artifacts:
      - build/app/outputs/flutter-apk/app-profile.apk
